---
id: 214
title: 'ASP.NETçš„æœ€æ–°å®‰å…¨æ¼æ´Important: ASP.NET Security Vulnerability'
date: '2019-08-16T12:59:59+08:00'
author: wenjie
layout: revision
guid: 'https://javascript.shop/213-revision-v1/'
permalink: '/?p=214'
---

å¾®è½¯åœ¨9æœˆ17å·ä¸­åˆæ­£å¼å¯¹å¤–å…¬å¸ƒäº†ASP.NETå¹³å°ä¸‹çš„å®‰å…¨æ¼æ´ï¼Œå³Microsoft Security Advisory (2416728)ã€‚

SecurityFocusä¸Šå·²å°†æ­¤æ¼æ´å®šä¹‰æˆäº†â€Design Errorâ€ï¼Œé‚£ä¹ˆå¾®è½¯ä¸€å¼€å§‹çš„è®¾è®¡å°±æ˜¯é”™è¯¯çš„ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿä¸”å¾…æˆ‘ä»¬æ…¢æ…¢æ¥åˆ†æã€‚

ä¸Šåˆåœ¨å›­å‹è¾°çš„ä¸€ç¯‡åšæ–‡ï¼šå¯¹ASP.NETçš„æœ€æ–°å®‰å…¨æ¼æ´è¿›ä¸€æ­¥è·Ÿè¿›è¯´æ˜ä¸­ä¹Ÿçœ‹åˆ°äº†å¯¹æ­¤é—®é¢˜çš„è¯¦ç»†è¿½è¸ªï¼Œä½†ä¸Šåˆä¹Ÿåªæ˜¯ç²—ç²—æµè§ˆï¼Œä¸‹åˆç»†çœ‹æ—¶æ€»è§‰æ–‡ä¸­æœ‰äº›åœ°æ–¹ç•¥æ˜¾å«ç³Šï¼Œæ‰€ä»¥æ™šä¸Šä¹Ÿå°±é¡ºå¸¦æŸ¥äº†äº›èµ„æ–™ï¼Œç•¥æœ‰æ‰€å¾—ï¼Œä¸æ•¢ç‹¬äº«ï¼Œé‚æˆæ­¤æ–‡ï¼å¾®è½¯çš„æ€åº¦

æŸ¥çœ‹äº†è®¸å¤šå¾®è½¯å®˜æ–¹çš„è¯´æ˜æ–‡æ¡£ï¼Œæ€»è§‰å¾—è¿™ä½å¤§å§‘å¨˜çŠ¯äº†é”™åæ€»æ˜¯æ˜¾å¾—æ‰­æ‰­ææï¼Œé®é®æ©æ©ï¼Œå½“ç„¶å¯¹äºè¿™ä¸ªæ¯”è¾ƒå¤§çš„å®‰å…¨æ¼æ´ï¼Œä¸ç®¡æ˜¯å‡ºäºå•†ä¸šè§’åº¦çš„è€ƒè™‘è¿˜æ˜¯å¯¹ç°æœ‰.NETæ¶æ„ç½‘ç«™çš„ä¿æŠ¤ï¼Œæˆ‘ä»¬éƒ½æš‚ä¸”ä¸å»è°ˆè®ºå®ƒï¼Œä½†æˆ‘æƒ³æ”»é˜²è¯¥æœ‰çš„ä¸€æ¡ç­–ç•¥å°±æ˜¯ï¼šçŸ¥å·±çŸ¥å½¼ï¼Œç™¾æˆ˜ä¸æ®†ï¼

é¦–å…ˆï¼Œæ¯”è¾ƒé•¿çš„ä¸€ç¯‡æ–‡ç« å°±æ˜¯ScottGuçš„è¿™ç¯‡ï¼šImportant: ASP.NET Security Vulnerabilityã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå…¶ä¸»è¦è°ˆåŠäº†æ­¤æ¼æ´çš„å½±å“ï¼Œç®€å•æåŠäº†ä¸€ä¸‹æ­¤æ¼æ´äº§ç”Ÿçš„åŸå› ï¼Œä¸‹é¢å°±æ˜¯å¾®è½¯æ•™ç§‘ä¹¦å¼çš„è§£å†³æ–¹æ¡ˆäº†ã€‚

è¿™ä¸ªè§£å†³æ–¹æ¡ˆæœ‰ä¸¤ä¸ªæ³¨æ„ç‚¹ï¼š

1ï¼š

If you are using ASP.NET 3.5 SP1 or ASP.NET 4.0 then you should follow the below steps to enable &lt;customErrors&gt; and map all errors to a single error page:

1\) Edit your ASP.NET Applicationâ€™s root Web.Config file. If the file doesnâ€™t exist, then create one in the root directory of the application.

2\) Create or modify the &lt;customErrors&gt; section of the web.config file to have the below settings. Note the use of redirectMode=â€ResponseRewriteâ€ with .NET 3.5 SP1 and .NET 4.0:

> &lt;configuration&gt; &lt;system.web&gt; &lt;customErrors mode=â€Onâ€ redirectMode=â€ResponseRewriteâ€ defaultRedirect=â€~/error.aspxâ€ /&gt; &lt;/system.web&gt;&lt;/configuration&gt;

3\) You can then add an Error.aspx to your application that contains an appropriate error page of your choosing (containing whatever content you like). This file will be displayed anytime an error occurs within the web application.

4\) We recommend adding the below code to the Page\_Load() server event handler within the Error.aspx file to add a random, small sleep delay. This will help to further obfuscate errors.

2ï¼šåœ¨é”™è¯¯é¡µé¢ä¸­æ·»åŠ çš„ä¸€æ®µä»£ç ï¼Œæˆ‘å…ˆè´´å‡ºæ¥ï¼Œçœ‹äº†ä¸‹é¢çš„åˆ†æï¼Œæˆ‘æƒ³ä½ å°±è¯¥ç†è§£é‚£æ®µä»£ç ä»€ä¹ˆæ„æ€äº†ã€‚

&lt;%@ Page Language=â€C#â€ AutoEventWireup=â€trueâ€ %&gt;  
&lt;%@ Import Namespace=â€System.Security.Cryptographyâ€ %&gt;  
&lt;%@ Import Namespace=â€System.Threadingâ€ %&gt;  
  
&lt;script runat=â€serverâ€&gt;  
 void Page\_Load() {  
 byte\[\] delay = new byte\[1\];  
 RandomNumberGenerator prng = new RNGCryptoServiceProvider();  
  
 prng.GetBytes(delay);  
 Thread.Sleep((int)delay\[0\]);  
   
 IDisposable disposable = prng as IDisposable;  
 if (disposable != null) { disposable.Dispose(); }  
 }  
&lt;/script&gt;  
  
&lt;html&gt;  
&lt;head runat=â€serverâ€&gt;  
 &lt;title&gt;Error&lt;/title&gt;  
&lt;/head&gt;  
&lt;body&gt;  
 &lt;div&gt;  
 An error occurred while processing your request.  
 &lt;/div&gt;  
&lt;/body&gt;  
&lt;/html&gt;

å½“ç„¶ï¼Œåœ¨è¿™é‡Œä½ è¿˜å¯ä»¥çœ‹åˆ°ä¸€äº›ç±»å®˜æ–¹çš„è®¨è®ºã€‚ä»€ä¹ˆå«Padding Oracle

åœ¨ScottGuçš„æ–‡ç« ä¸­ä¹Ÿæåˆ°äº†Padding Oracleï¼Œâ€â€¦â€¦, there is a vulnerability in ASP.NET which acts as a padding oracleâ€ã€‚

é¦–å…ˆå¾—æ‰¿è®¤ï¼Œpaddingå’ŒOracleçš„ç¡®å¤ªè¿·æƒ‘äººäº†ï¼Œcss+æ•°æ®åº“ï¼Œè¿˜æŒºæŒ‘æˆ˜æƒ³è±¡åŠ›çš„ã€‚

æœ¬äººä¹Ÿæƒ³ä¸å‡ºå¤ªå¥½çš„ä¸­æ–‡ç¿»è¯‘ï¼Œå°±ç›´è¯‘æˆäº†â€é™„åŠ æ–­è¨€â€(oracle: ç¥è°•ã€é¢„è¨€)ï¼Œè¿˜æœ›å„ä½æŒ‡æ­£ã€‚

å¥½äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹Padding Oracleåˆ°åº•æ˜¯ä»€ä¹ˆã€‚

åœ¨ASP.NETä¸­è®¾è®¡ViewStateç­‰åŠ å¯†å­—ç¬¦ä¸²æ—¶ï¼Œåœ¨åŠ å¯†ç®—æ³•ä¸­ï¼Œå½“æäº¤ä¸€ä¸ªæ–‡æœ¬(ciphertext)å»åŠ å¯†åï¼ŒåŠ å¯†å‡½æ•°å°†è¿”å›æ˜¯å¦æˆåŠŸï¼Œå¦‚è¿”å›validæˆ–invalidã€‚

é‚£ä¹ˆæ”»å‡»è€…ä½¿ç”¨ä¸åŒçš„å€¼å»æäº¤ï¼Œå¹¶æ•è·è¿”å›çš„å€¼ï¼Œå¯¹æ¯æ¬¡è¿”å›çš„å€¼è¿›è¡Œåˆ†æï¼Œå†çº æ­£ï¼Œé‡æ–°æäº¤ï¼Œå°±è¿™æ ·è§£å¯†å‡ºåŸæ–‡ã€‚é‚£ä¹ˆéœ€è¦å¤šå°‘æ¬¡å¯ä»¥è§£å¯†å‡ºåˆ°æ˜æ–‡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š128\*Nï¼ŒNæ˜¯è¿™æ®µå¯†æ–‡çš„å­—èŠ‚æ•°ï¼Œæ‰€ä»¥ä¹Ÿå°±æœ‰äº†åšå‹è¾°æ–‡ç« ä¸­æåˆ°çš„ï¼š è¿™ä¸ªè¿‡ç¨‹100%æˆåŠŸè€Œä¸”åªéœ€è¦30åˆ†é’Ÿã€‚ï¼ˆå½“ç„¶ï¼šä¸ä¼šæ˜¯100%æˆåŠŸçš„ï¼ï¼‰

åŸæ–‡æ˜¯è¿™æ ·çš„ï¼š

The attack works under the assumption that the attackers can intercept padded messages encrypted in CBC mode, and have access to the aforementioned padding oracle. The result is that attackers can recover the plaintext corresponding to any block of ciphertext using an average of 128 \* b oracle calls, where b is the number of bytes in a block.

ç†è§£æœ‰å¤±åé¢‡çš„ï¼Œæé†’ä¸‹ã€‚

é‚£ä¹ˆåœ¨åšå‹è¾°çš„æ–‡ç« ä¸­è¿˜æåˆ°äº†ï¼šè¿™ä¸ªé—®é¢˜ä¸ä»…ä»…å­˜åœ¨äºasp.net,è€Œä¸”è¿˜æœ‰javaç­‰ã€‚

è¿™ä¸ªèƒŒæ™¯åœ¨äºï¼šåœ¨éšè—å­—æ®µï¼ˆå¦‚ViewStateï¼‰ï¼Œcookiesï¼Œè¯·æ±‚å‚æ•°ä¸­ï¼Œå½“åŠ å¯†æˆBASE64å­—ç¬¦ä¸²æ—¶éƒ½æ¶‰åŠåˆ°è¿™ä¸ªæ¼æ´ï¼Œè€Œåœ¨ä¸€äº›Javaæ¡†æ¶ï¼Œå¦‚JavaServer Faceä¸­ä¹Ÿè®¾è®¡äº†ViewStateçš„ä¸œè¥¿ï¼Œæ‰€ä»¥æ‰æœ‰äº†ä¸Šé¢çš„ç»“è®ºã€‚å¦‚ä½•æ”»å‡»

å…¶å®æ­¤æ¼æ´çš„åˆ©ç”¨åœ¨2002å¹´çš„Eurocryptä¼šè®®ä¸­å·²ç»è¢«æåŠè¿‡äº†ï¼Œå¯ä»¥å»BlackHatç½‘ç«™ä¸‹è½½PDFæŸ¥çœ‹ï¼Œæœ¬äººä¸Šæ–‡çš„è®¸å¤šåˆ†æä¹Ÿæç‚¼è‡ªæ­¤æ–‡æ¡£ã€‚

Then we decode each Base64 string found. If the result looks random, and its length is a multiple of common block cipher sizes, i.e. 8, 16 or 32 bytes, then thereâ€™s a good chance that it is a ciphertext. We also look for common separators, i.e. â€“, | or :, which are often used to separate IV, ciphertext, or MAC. Then we replace a byte in the last block of the ciphertext by a random value, then send it back to the target, and see what changes in the response. If there is an error message, then thereâ€™s a high chance that this is a Padding Oracle.

æ­¤æ®µè‹±æ–‡å°±æ¯”è¾ƒç®€å•äº†ï¼Œä¹Ÿå¾ˆæ˜äº†åœ°è¯´æ˜äº†æµ‹è¯•æ˜¯å¦å¯ç ´è§£çš„æ–¹æ³•ã€‚

æ¯æ¬¡æ›¿æ¢æ‰æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶å°†æ–°æ‹¼æ¥çš„å­—ç¬¦ä¸²æäº¤åŠ å¯†ï¼Œå†è®°å½•è¿”å›ç»“æœï¼Œå¦‚æœå¯ä»¥ï¼Œé‚£ä¹ˆå†è¿›ä¸€æ­¥è§£å¯†å‡ºåŸæ–‡ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¤§æ¦‚å¯¹æ­¤æ¼æ´æœ‰äº†ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ï¼Œæ¬²æ·±å…¥åˆ†æè¯·æŸ¥çœ‹ä¸Šé¢çš„PDFæ–‡æ¡£ã€‚

å†å›è¿‡æ¥çœ‹ScottGuå…¬å¸ƒçš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘çš„çŒœæƒ³æ˜¯ï¼š

æ·»åŠ é”™è¯¯é…ç½®èŠ‚ï¼Œå½“æ”»å‡»è€…ç¬¬ä¸€æ¬¡å°è¯•ç ´è§£æ—¶ï¼Œè¢«é…ç½®èŠ‚å¼ºåˆ¶è·³è½¬åˆ°é”™è¯¯é¡µé¢ï¼Œåœ¨é”™è¯¯é¡µé¢ä¸­ï¼Œå¦‚æœå‘ç°æäº¤è¿‡æ¥çš„æ„é€ å¯†ç ç§å­(æˆ‘ç†è§£æˆäº†ç§å­ ğŸ™‚ )ä¸º1ï¼Œé‚£ä¹ˆå°±å°†å…¶å¯¹è±¡å¼ºè¡ŒDisposeæ‰ï¼Œé‚£ä¹ˆæ”»å‡»è€…ä¹Ÿå°±æ²¡æ³•ç»§ç»­ä¸‹å»äº†ã€‚å°ç»“

é‚£ä¹ˆå¾®è½¯å°†å¦‚ä½•å»ä¿®å¤æ­¤æ¼æ´å‘¢ï¼Œä¿®æ”¹åŠ å¯†æœºåˆ¶ï¼Œè¿˜æ˜¯â€¦â€¦ï¼ŒæŒç»­å…³æ³¨ã€‚

å¥½äº†ï¼Œæˆ‘çš„åˆ†æå°±åˆ°è¿™é‡Œï¼Œä¹Ÿå¾ˆæ™šäº†ï¼Œæ–‡ç« ä¸­æ¬ å¦¥çš„åœ°æ–¹ï¼Œæ¬¢è¿æ‹ç –ï¼Œä¸€èµ·å†è®¨è®ºä¸‹ï¼